<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Track Rejoice</title>
    <!--  <link href="http://cdn.jsdelivr.net/webjars/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet" media="screen"/>-->

    <!--  <script src="http://cdn.jsdelivr.net/webjars/jquery/2.1.4/jquery.min.js"></script>-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://bootswatch.com/5/lux/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/app.js"></script>

</head>
<body>
<div th:replace="~{fragments/navbar::navbar}"></div>
<div class="container">
    <div id="mapid" style="width: 600px; height: 400px;"></div>
    <form th:action="@{/search}" method="post" id="form">
        <input type="text" th:name="lat" id="lat" hidden>
        <input type="text" th:name="lng" id="lng" hidden>
        <input type="text" th:name="zoom" id="zoom">
        <input type="submit" value="Search">
    </form>
</div>
<div class="container bg-white shadow-md p-5 form-layout text-center">

    <div th:if="${#lists.isEmpty(pets)}">
        <div th:replace="~{fragments/empty_table::empty_table}"></div>
    </div>
    <div th:unless="${#lists.isEmpty(pets)}">
        <div th:replace="~{fragments/value_table::value_table}"></div>
    </div>
</div>
<script th:inline="javascript">
    var mymap = L.map('mapid', {
        minZoom: 3,
        maxZoom: 18
    })
    var data = [[${pets}]];
    var zoom = [[${zoom}]]

    if (data && 0 < data.length && data[0].latitude !== null && data[0].longitude !== "") {
        mymap.setView([data[0].latitude, data[0].longitude], 10);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Pets'
        }).addTo(mymap);


        console.log("list: " + data.length);
        for (var i = 0; i < data.length; i++) {
            if (data[i].latitude !== null && data[i].longitude !== "") {
                L.marker([data[i].latitude, data[i].longitude]).addTo(mymap)
                    .bindPopup(data[i].name)
                    .openPopup();
            }
        }
    } else {
        var centre_lng = [[${centre_lng}]];
        var centre_lat = [[${centre_lat}]];
        mymap.setView([centre_lat, centre_lng], zoom);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Pets'
        }).addTo(mymap);
    }
    document.getElementById('zoom').value = mymap.getZoom();

    mymap.on('zoom', function () {
        document.getElementById('zoom').value = mymap.getZoom()

    });
    mymap.on('click', function (e) {
        // Get the click coordinates relative to the map
        var clickPoint = mymap.mouseEventToLayerPoint(e.originalEvent);

        // Access the X and Y coordinates of the click
        var x = clickPoint.x;
        var y = clickPoint.y;

        console.log("Clicked at X:", x, "Y:", y);
        var lat = e.latlng.lat
        var lng = e.latlng.lng
        // location = '/search?lng=' + x + '&lat=' + y + '&distance=1'
        // (param1 = 'value1', param2 = 'value2');
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
        // You can use these coordinates for further actions, like displaying a popup
    });
</script>
</body>
</html>